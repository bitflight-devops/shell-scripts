#!/usr/bin/env bash
run_after_wait() {
  local -r wait_in_seconds="$1"
  shift
  sleep "${wait_in_seconds}"s
  "$@"
}
generate_antigen_cache() {
  SECONDS_IN_DAY=86400
  SECONDS_IN_WEEK=$((SECONDS_IN_DAY * 7))

  mkdir -p ~/.cache/antigen
  run_timer="${HOME}/.cache/antigen/antigen.cachegen.last_run"

  if [[ ! -f "${run_timer}" ]]; then
    touch "${run_timer}"
    last_run_time="$(date +%s)"
  else
    last_run_time="$(stat -f "%m" "${run_timer}")"
  fi

  if [[ "$(date +%s)" -gt "$((last_run_time + SECONDS_IN_WEEK))" ]]; then
    touch "${run_timer}"
    setopt local_options no_notify no_monitor
    run_after_wait "$((130 + RANDOM % 100))" antigen cache-gen &
  fi
}
generate_antigen_cache
antigen use oh-my-zsh
antigen bundles <<EOBUNDLES
git
asdf
# curl
fzf
aws
brew
docker
iterm2
macos
npm
nvm
thefuck
tmux
vscode
yarn
zoxide
Aloxaf/fzf-tab
zdharma-continuum/fast-syntax-highlighting
\
  zsh-users/zsh-autosuggestions \
  zsh-users/zsh-completions \
  zsh-users/zsh-history-substring-search
EOBUNDLES
antigen theme romkatv/powerlevel10k
antigen apply
[[ -n ${ZSH_CACHE_DIR} ]] && [[ ! -d "${ZSH_CACHE_DIR}/completions" ]] && mkdir -p "${ZSH_CACHE_DIR}/completions" # Fix gh plugin
